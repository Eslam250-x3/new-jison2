<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø°ÙƒÙŠ (ID ÙØ§Ø±Øº)</title>
    <!-- ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ JSZip Ø£ÙˆÙ„Ø§Ù‹ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Handsontable CSS & JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.min.js"></script>
    <style>
        /* --- Basic Setup --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- Main Container --- */
        .container {
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* --- Header --- */
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .ai-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            backdrop-filter: blur(10px);
        }

        /* --- Content Layout --- */
        .content {
            padding: 40px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
        }

        .panel {
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e2e8f0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .panel:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .panel h3 {
            color: #4f46e5;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* --- Input & Controls --- */
        .input-section textarea {
            width: 100%;
            min-height: 350px;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            font-size: 16px;
            line-height: 1.6;
            resize: vertical;
            transition: all 0.3s ease;
            background: white;
            font-family: 'Courier New', monospace;
        }

        .input-section textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .api-key-section {
            margin-top: 15px;
        }

        .api-key-section input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .api-key-section input:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .controls .btn { flex-grow: 1; }

        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover:before { left: 100%; }
        .btn:disabled { cursor: not-allowed; opacity: 0.6; }

        .btn-primary { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3); }
        .btn-secondary { background: #f3f4f6; color: #374151; border: 2px solid #d1d5db; }
        .btn-secondary:hover:not(:disabled) { background: #e5e7eb; border-color: #9ca3af; }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .btn-ai { background: linear-gradient(135deg, #ec4899 0%, #d946ef 100%); color: white; }
        .btn-ai:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(236, 72, 153, 0.3); }

        /* --- JSON Output --- */
        .json-output {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #334155;
            flex-grow: 1;
            margin-top: 15px;
        }

        .json-output .key { color: #60a5fa; }
        .json-output .string { color: #34d399; }
        .json-output .number { color: #fbbf24; }
        .json-output .boolean { color: #f87171; }
        .json-output .null { color: #a78bfa; }
        
        /* --- Preview & Analysis --- */
        .analysis-section { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .analysis-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f3f4f6; font-size: 0.9em; }
        .analysis-item:last-child { border-bottom: none; }
        .confidence-bar { width: 100px; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .confidence-fill { height: 100%; background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981); border-radius: 4px; transition: width 0.5s ease-in-out; }

        #questionsPreview { flex-grow: 1; overflow-y: auto; max-height: 70vh; }
        .question-preview { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); animation: fadeIn 0.5s ease; position: relative; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .question-actions { position: absolute; top: 10px; left: 10px; display: none; gap: 8px; z-index: 10; }
        .question-preview:hover .question-actions { display: flex; }
        .action-btn { background: rgba(249, 250, 251, 0.8); border: 1px solid #d1d5db; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; backdrop-filter: blur(2px); }
        .action-btn:hover { background: #4f46e5; border-color: #4f46e5; color: white; transform: scale(1.1); }
        .action-btn:disabled { opacity: 0.4; cursor: not-allowed; background: #e5e7eb; }
        
        .question-preview h4 { color: #374151; margin-bottom: 10px; font-size: 1.1em; line-height: 1.5; }
        .question-type-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: bold; margin-bottom: 10px; }
        .type-multiple_choice { background: #dbeafe; color: #1e40af; }
        .type-true_false { background: #fef3c7; color: #92400e; }
        .type-fill_blank { background: #d1fae5; color: #065f46; }
        .type-essay { background: #fce7f3; color: #be185d; }
        .type-matching { background: #e0e7ff; color: #3730a3; }
        .type-short_answer { background: #e5e7eb; color: #374151; }
        .type-unknown { background: #fee2e2; color: #991b1b; }
        
        .choice-item { padding: 8px 15px; margin: 5px 0; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; cursor: pointer; transition: all 0.2s ease; }
        .choice-item:hover { background: #f3f4f6; border-color: #4f46e5; }
        .choice-item.correct { background: #dcfce7; border-color: #16a34a; color: #15803d; font-weight: bold; }
        .choice-item.correct::before { content: 'âœ” '; color: #15803d; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); border: 1px solid #e5e7eb; transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08); }
        .stat-card h4 { color: #4f46e5; margin-bottom: 10px; font-size: 0.9em; }
        .stat-card span { font-size: 2em; font-weight: bold; color: #1f2937; }

        /* --- Loading & Messages --- */
        .loading { display: none; text-align: center; padding: 20px; }
        .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        .btn .spinner { width: 20px; height: 20px; margin: 0; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .message-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .message { padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); animation: slideIn 0.5s ease, fadeOut 0.5s ease 3.5s forwards; font-weight: 500; min-width: 300px; text-align: center; }
        .message.error { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; }
        .message.success { background: #dcfce7; color: #065f46; border: 1px solid #a7f3d0; }
        .message.warning { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        @keyframes slideIn { from { transform: translateY(-50px) translateX(-50%); opacity: 0; } to { transform: translateY(0) translateX(-50%); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-20px) translateX(-50%); } }

        /* --- Responsive Design --- */
        @media (max-width: 1200px) { .content { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 768px) { body { padding: 10px; } .content { grid-template-columns: 1fr; padding: 20px; } .header h1 { font-size: 2em; } .header p { font-size: 1em; } .controls { flex-direction: column; } .btn { width: 100%; } }

        /* Handsontable modal styles */
        #csvModalBg {
            display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.25); z-index: 3000; align-items: center; justify-content: center;
        }
        #csvModal {
            background: white; border-radius: 16px; max-width: 1200px; width: 95vw; padding: 32px 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15); position: relative; min-height: 600px; min-width: 900px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #csvModal .hot-container { margin-bottom: 18px; width: 100%; }
        #csvModal .btn { min-width: 120px; }
        #csvModal .csv-warning { color: #dc2626; font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div id="messageContainer" class="message-container"></div>
    <div class="container">
        <div class="header">
            <div class="ai-badge">ğŸ¤– AI Powered</div>
            <h1>ğŸš€ Ù…Ø­ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø°ÙƒÙŠ</h1>
            <p>Ø­ÙˆÙ‘Ù„ Ù†ØµÙˆØµ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¥Ù„Ù‰ ØµÙŠØºØ© JSON Ù…ØªÙ‚Ø¯Ù…Ø© Ø¨Ø¶ØºØ·Ø© Ø²Ø±</p>
        </div>

        <div class="content">
            <!-- Input Panel -->
            <div class="panel">
                <h3>ğŸ“ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
                <div class="input-section">
                    <textarea id="questionInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‡Ù†Ø§... Ù…Ø«Ø§Ù„:
1. Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ù…ØµØ±ØŸ
Ø£) Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©*
Ø¨) Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©

2. Ø§Ù„Ø´Ù…Ø³ ØªØ´Ø±Ù‚ Ù…Ù† Ø§Ù„ØºØ±Ø¨. (Ø®Ø·Ø£)
"></textarea>
                </div>
                <div class="api-key-section">
                     <input type="password" id="apiKey" placeholder="ğŸ”‘ Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Gemini API Ù‡Ù†Ø§">
                </div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="app.smartAnalyze()">ğŸ¤– ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ</button>
                    <button class="btn btn-ai" id="aiEnhanceBtn" onclick="app.enhanceWithAI()">ğŸ’ ØªØ­Ø³ÙŠÙ† Ø¨Ø§Ù„Ù€ AI</button>
                    <button class="btn btn-secondary" id="customizeBtn" onclick="app.openCustomizeModal()">âš™ï¸ ØªØ®ØµÙŠØµ</button>
                    <button class="btn btn-warning" id="langSwitchBtn" onclick="app.toggleLanguage()">ğŸŒ English</button>
                </div>
                 <div class="controls">
                    <button class="btn btn-success" onclick="app.convertToJSON()">ğŸ”„ ØªØ­ÙˆÙŠÙ„ Ù„Ù€ JSON Ù…ØªÙ‚Ø¯Ù…</button>
                    <button class="btn btn-secondary" onclick="app.clearAll()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
                </div>
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</p>
                </div>
            </div>

            <!-- Analysis & Output Panel -->
            <div class="panel">
                <h3>ğŸ” ØªØ­Ù„ÙŠÙ„ ÙˆÙ…Ø®Ø±Ø¬Ø§Øª</h3>
                <div class="analysis-section" id="analysisSection">
                    <div class="analysis-item"><span>Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒØ´Ù:</span><div class="confidence-bar"><div id="detectionQuality" class="confidence-fill" style="width: 0%"></div></div></div>
                    <div class="analysis-item"><span>Ø¯Ù‚Ø© Ø§Ù„ØªØµÙ†ÙŠÙ:</span><div class="confidence-bar"><div id="classificationAccuracy" class="confidence-fill" style="width: 0%"></div></div></div>
                    <div class="analysis-item"><span>Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</span><div class="confidence-bar"><div id="dataCompleteness" class="confidence-fill" style="width: 0%"></div></div></div>
                </div>
                <div class="stats" id="stats">
                    <div class="stat-card"><h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h4><span id="totalQuestions">0</span></div>
                    <div class="stat-card"><h4>Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯</h4><span id="multipleChoice">0</span></div>
                    <div class="stat-card"><h4>ØµØ­/Ø®Ø·Ø£</h4><span id="trueFalse">0</span></div>
                    <div class="stat-card"><h4>Ù…Ù‚Ø§Ù„ÙŠØ©</h4><span id="essay">0</span></div>
                    <div class="stat-card"><h4>ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ</h4><span id="unknown">0</span></div>
                    <div class="stat-card"><h4>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø«Ù‚Ø©</h4><span id="confidenceScore">0%</span></div>
                </div>
                <div class="json-output" id="jsonOutput" style="display: none;"></div>
                <div class="controls" style="margin-top: auto;">
                    <button class="btn btn-secondary" id="copyBtn" onclick="app.copyJSON()" disabled>ğŸ“‹ Ù†Ø³Ø® JSON</button>
                    <button class="btn btn-warning" id="downloadBtn" onclick="app.downloadJSON()" disabled>ğŸ’¾ ØªØ­Ù…ÙŠÙ„</button>
                    <button class="btn btn-warning" id="downloadZipBtn" onclick="app.downloadZip()" disabled>ğŸ—œï¸ ØªØ­Ù…ÙŠÙ„ ÙƒÙ€ ZIP</button>
                    <button class="btn btn-secondary" id="csvBtn" onclick="app.openCSVModal()">ğŸ“„ CSV</button>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="panel">
                <h3>ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
                <div id="questionsPreview">
                    <div style="text-align: center; color: #6b7280; padding: 40px; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“‹</div>
                        <p>Ø³ØªØ¸Ù‡Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="customizeModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:2000; align-items:center; justify-content:center;">
        <div style="background:white; border-radius:16px; max-width:400px; width:90vw; padding:32px 24px; box-shadow:0 8px 32px rgba(0,0,0,0.15); position:relative;">
            <button onclick="app.closeCustomizeModal()" style="position:absolute; top:12px; left:12px; background:none; border:none; font-size:1.5em; cursor:pointer;">&times;</button>
            <h2 style="text-align:center; margin-bottom:24px; color:#4f46e5;">ØªØ®ØµÙŠØµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
            <div style="margin-bottom:18px;">
                <label for="categorySelect" style="font-weight:bold;">Category</label>
                <select id="categorySelect" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e5e7eb; margin-top:6px;"
                    onchange="app.handleCustomizationChange()">
                    <option value="lesson" selected>lesson</option>
                    <option value="exam">exam</option>
                </select>
            </div>
            <div style="margin-bottom:18px;">
                <label for="countrySelect" style="font-weight:bold;">Country</label>
                <select id="countrySelect" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e5e7eb; margin-top:6px;"
                    onchange="app.handleCustomizationChange()">
                    <option value="eg" selected>eg</option>
                    <option value="bh">bh</option>
                    <option value="cn">cn</option>
                    <option value="dj">dj</option>
                    <option value="fr">fr</option>
                    <option value="in">in</option>
                    <option value="iq">iq</option>
                    <option value="jm">jm</option>
                    <option value="jo">jo</option>
                    <option value="kw">kw</option>
                    <option value="lb">lb</option>
                    <option value="om">om</option>
                    <option value="pt">pt</option>
                    <option value="qa">qa</option>
                    <option value="sa">sa</option>
                    <option value="ae">ae</option>
                    <option value="uk">uk</option>
                    <option value="us">us</option>
                </select>
            </div>
            <div style="margin-bottom:24px;">
                <label for="dialectSelect" style="font-weight:bold;">Dialect</label>
                <select id="dialectSelect" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e5e7eb; margin-top:6px;"
                    onchange="app.handleCustomizationChange()">
                    <option value="Modern_standard" selected>Modern_standard</option>
                </select>
            </div>
            <button class="btn btn-primary" style="width:100%;" onclick="app.saveCustomization()">Ø­ÙØ¸</button>
        </div>
    </div>

    <!-- Handsontable CSV Modal -->
    <div id="csvModalBg">
      <div id="csvModal">
        <button onclick="app.closeCSVModal()" style="position:absolute; top:12px; left:12px; background:none; border:none; font-size:1.5em; cursor:pointer;">&times;</button>
        <h2 style="text-align:center; margin-bottom:18px; color:#4f46e5;">CSV Editor</h2>
        <div class="csv-warning" id="csvWarning" style="display:none;"></div>
        <div id="hotTable" class="hot-container"></div>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:18px;">
          <button class="btn btn-success" onclick="app.saveCSVData()">ğŸ’¾ Ø­ÙØ¸</button>
          <button class="btn btn-secondary" onclick="app.closeCSVModal()">âŒ Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    </div>

    <script>
        class AIQuestionConverter {
            constructor() {
                this.questions = [];
                this.isAIProcessing = false;
                this.jsonForExport = '';
                this.customization = {
                    category: 'lesson',
                    country: 'eg',
                    dialect: 'Modern_standard'
                };
                this.language = 'ar'; // 'ar' or 'en'
                this.apiKey = '';
                this.patterns = {
                    multipleChoice: /([Ø£-ÙŠ]\s*[.)-]|^\d+\s*[.)-])/m,
                    trueFalse: /(ØµØ­\s*(Ø£Ù…|Ø£Ùˆ|\/)\s*Ø®Ø·Ø£|true\s*(or|\/)\s*false)/i,
                    fillBlank: /(____+|\[\s*.*?s*\]|\{\s*.*?s*\}|\(\s*.*?s*\)|Ø£ÙƒÙ…Ù„|Ø§Ù…Ù„Ø£)/i,
                    matching: /(ØµÙ„|Ø§Ø±Ø¨Ø·|ÙˆØµÙ„|Ø·Ø§Ø¨Ù‚)/i,
                    essay: /(Ø§Ø´Ø±Ø­|ÙˆØ¶Ø­|Ù†Ø§Ù‚Ø´|ØªØ­Ø¯Ø«|Ø§ÙƒØªØ¨|ØµÙ|Ø¹Ù„Ù„|Ø¨Ø±Ø±|Ù…Ø§ Ø±Ø£ÙŠÙƒ|Ù„Ù…Ø§Ø°Ø§|ÙƒÙŠÙ)/i,
                    en_multipleChoice: /([A-Da-d]\s*[.)-]|^\d+\s*[.)-])/m,
                    en_trueFalse: /(true\s*(or|\/)\s*false)/i,
                    en_essay: /(explain|describe|discuss|write|why|how|justify|reason)/i
                };
                this.loadSettings();
                this.loadApiKey();
                this.csvData = [];
                this.hotInstance = null;
            }

            // ===== Main Actions =====

            smartAnalyze() {
                const input = document.getElementById('questionInput').value.trim();
                if (!input) {
                    this.showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ù„Ù„ØªØ­Ù„ÙŠÙ„', 'warning');
                    return;
                }
                this.showLoading(true, 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ...');
                setTimeout(() => {
                    this.processText(input);
                    this.showLoading(false);
                }, 500);
            }

            async enhanceWithAI() {
                const apiKey = document.getElementById('apiKey').value.trim();
                if (!apiKey) {
                    this.showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ Gemini API Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©', 'error');
                    return;
                }
                const rawText = document.getElementById('questionInput').value.trim();
                if (!rawText) {
                    this.showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ù„Ù„ØªØ­Ø³ÙŠÙ†', 'warning');
                    return;
                }
                if (this.isAIProcessing) return;

                this.isAIProcessing = true;
                this.toggleAIButtonLoading(true);

                try {
                    const prompt = `
                        You are an expert system for structuring test questions from raw text into a simple JSON format.
                        Task: Analyze the following raw text containing questions.
                        Your job is to return a single, valid JSON array of question objects.
                        Each object must have:
                        - "type": (string) one of "multiple_choice", "true_false", "essay", "short_answer", "fill_blank", "matching".
                        - "question": (string) The text of the question itself.
                        - "choices": (array of strings) The list of possible answers. For true/false, use ["True", "False"] or ["ØµØ­", "Ø®Ø·Ø£"]. For other types, this can be an empty array.
                        - "answer": (number or string) For multiple_choice/true_false, this is the 0-based index of the correct choice in the "choices" array. For other types, it can be the correct string answer. If the answer is not clear, use null.
                        - "confidence": (number) Your confidence in the accuracy of the extraction, from 0.0 to 1.0.

                        Raw Text:
                        ---
                        ${rawText}
                        ---

                        IMPORTANT: Return ONLY the raw JSON array. Do not include any explanatory text, markdown formatting like \`\`\`json, or anything else. Your entire response must be the JSON array itself.
                    `;

                    const aiResult = await this.callGeminiAPI(prompt, apiKey);

                    if (aiResult && Array.isArray(aiResult)) {
                        this.questions = aiResult.map((q, index) => {
                            const questionText = q.question || "No question text found";
                            const questionType = q.type || "unknown";
                            const choices = q.choices || [];
                            let answerIndex = q.answer;
                            if (questionType === 'multiple_choice' || questionType === 'true_false') {
                                if (typeof answerIndex !== 'number' || answerIndex < 0 || answerIndex >= choices.length) {
                                    answerIndex = null;
                                }
                            }

                            return {
                                id: index + 1,
                                originalText: `AI: ${questionText.substring(0, 50)}...`,
                                type: questionType,
                                confidence: q.confidence || 0.85,
                                question: questionText,
                                choices: choices,
                                answer: answerIndex
                            };
                        });
                        this.updateUIAfterChange('ØªÙ… ØªØ­Ø³ÙŠÙ† ÙˆØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ!');
                    } else {
                        this.showMessage('Ø§Ø³ØªØ¬Ø§Ø¨ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¨ØµÙŠØºØ© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø© Ø£Ùˆ ÙØ§Ø±ØºØ©.', 'error');
                    }

                } catch (error) {
                    console.error('AI Enhancement Error:', error);
                    this.showMessage(`Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ AI: ${error.message}`, 'error');
                } finally {
                    this.isAIProcessing = false;
                    this.toggleAIButtonLoading(false);
                }
            }

            // =================================================================
            // ===== THIS IS THE CORRECTED FUNCTION =====
            // =================================================================
            transformToAdvancedFormat(question, index) {
                const typeMap = {
                    multiple_choice: 'mcq', true_false: 'mcq', essay: 'essay',
                    fill_blank: 'fill_blank', short_answer: 'short_answer',
                    matching: 'matching', unknown: 'unknown'
                };

                const n = index + 1;
                
                const sourceIdValue = 123567889 + n;
                const publicationDate = "2023-10-12T00:00:00";
                const instancesCount = 10;
                const category = this.customization.category || 'lesson';
                const country = this.customization.country || 'us';
                const language = this.language || 'en';
                const dialect = [this.customization.dialect || 'Modern_standard'];

                const part = {
                    n: n,
                    stem: `<p>${this.escapeHtml(question.question)}</p>`,
                    type: typeMap[question.type] || 'unknown',
                    answer: null,
                    choices: [],
                    subtype: null,
                    standalone: true
                };

                if ((question.type === 'multiple_choice' || question.type === 'true_false') && Array.isArray(question.choices)) {
                    part.choices = question.choices.map((choice, i) => {
                        const isCorrect = (i === question.answer);
                        return {
                            type: isCorrect ? 'key' : 'distractor',
                            unit: isCorrect ? '<span>unit</span>' : null,
                            index: i,
                            values: isCorrect ? [{ type: 'decimal', value: '1' }] : [],
                            last_order: false,
                            fixed_order: (i === 0) ? 4 : (i === 1) ? 1 : (i === 2) ? 3 : 2,
                            html_content: `<span>${this.escapeHtml(choice)}</span>`
                        };
                    });
                }

                const metadata = {
                    // --- MODIFIED ---
                    // These fields are now intentionally left null (empty) as requested.
                    id: null,
                    mapped_id: null,

                    title: "",
                    automark: true,
                    category: category,
                    country: country,
                    language: language,
                    dialect: dialect,
                    source_id: { value: sourceIdValue, page_number: null },
                    description: question.question,
                    has_example: true,
                    parts_count: 1,
                    instances_count: instancesCount,
                    publication_date: publicationDate
                };

                return {
                    parts: [part],
                    metadata: metadata,
                    statement: null
                };
            }
            
            convertToJSON() {
                if (this.questions.length === 0) {
                    this.showMessage('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„Ù‡Ø§. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.', 'warning');
                    return;
                }
                const advancedFormatQuestions = this.questions.map((q, index) => this.transformToAdvancedFormat(q, index));
                
                const jsonOutput = document.getElementById('jsonOutput');
                
                this.jsonForExport = JSON.stringify(advancedFormatQuestions, null, 2);
                
                jsonOutput.innerHTML = this.syntaxHighlight(this.jsonForExport);
                jsonOutput.style.display = 'block';
                document.getElementById('copyBtn').disabled = false;
                document.getElementById('downloadBtn').disabled = false;
                
                this.showMessage('ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }

            clearAll() {
                document.getElementById('questionInput').value = '';
                this.questions = [];
                this.jsonForExport = '';
                this.updateUIAfterChange();
                const jsonOutput = document.getElementById('jsonOutput');
                jsonOutput.style.display = 'none';
                jsonOutput.innerHTML = '';
                document.getElementById('copyBtn').disabled = true;
                document.getElementById('downloadBtn').disabled = true;
                document.getElementById('downloadZipBtn').disabled = true;
                localStorage.removeItem('aiq_csv_data');
                this.showMessage('ØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø´ÙŠØ¡', 'success');
            }
            
            copyJSON() {
                if (!this.jsonForExport) {
                    this.showMessage('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠØ¡ Ù„Ù†Ø³Ø®Ù‡', 'warning');
                    return;
                }
                const textArea = document.createElement('textarea');
                textArea.value = this.jsonForExport;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    this.showMessage('ØªÙ… Ù†Ø³Ø® JSON Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©', 'success');
                } catch (err) {
                    this.showMessage('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®', 'error');
                }
                document.body.removeChild(textArea);
            }

            downloadJSON() {
                if (!this.jsonForExport) {
                    this.showMessage('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠØ¡ Ù„ØªØ­Ù…ÙŠÙ„Ù‡', 'warning');
                    return;
                }
                const blob = new Blob([this.jsonForExport], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'advanced_questions.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.showMessage('Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù...', 'success');
            }

            downloadZip() {
                if (typeof JSZip === 'undefined') {
                    this.showMessage('Ù…ÙƒØªØ¨Ø© JSZip ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©.', 'error');
                    return;
                }
                if (this.questions.length === 0) {
                    this.showMessage('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„Ù‡Ø§', 'warning');
                    return;
                }
                const zip = new JSZip();
                const advancedFormatQuestions = this.questions.map((q, idx) => this.transformToAdvancedFormat(q, idx));

                advancedFormatQuestions.forEach((advQ, idx) => {
                    const questionIdFromCsv = (this.csvData && this.csvData[idx] && this.csvData[idx]['Question Id']);
                    // Fallback to a generic name if CSV ID is not available
                    const filename = `${questionIdFromCsv || ('question_' + (idx + 1))}.json`;
                    
                    const content = JSON.stringify(advQ, null, 2);
                    zip.file(filename, content);
                });
                
                if (this.csvData && this.csvData.length > 0) {
                    zip.file('questions.csv', this.getCSVString());
                }
                zip.generateAsync({ type: 'blob' }).then((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'questions.zip';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    this.showMessage('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù ZIP Ø¨Ù†Ø¬Ø§Ø­', 'success');
                });
            }

            deleteQuestion(id) {
                const questionIndex = this.questions.findIndex(q => q.id === id);
                if (questionIndex > -1) {
                    this.questions.splice(questionIndex, 1);
                    this.updateUIAfterChange('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­');
                }
            }

            mergeQuestions(id) {
                const questionIndex = this.questions.findIndex(q => q.id === id);
                if (questionIndex > -1 && questionIndex < this.questions.length - 1) {
                    const currentQuestion = this.questions[questionIndex];
                    const nextQuestion = this.questions[questionIndex + 1];
                    
                    const mergedText = (currentQuestion.originalText || currentQuestion.question) + '\n\n' + (nextQuestion.originalText || nextQuestion.question);
                    
                    const reAnalyzedQuestion = this.analyzeQuestion(mergedText, currentQuestion.id);
                    reAnalyzedQuestion.originalText = mergedText;
                    
                    this.questions[questionIndex] = reAnalyzedQuestion;
                    this.questions.splice(questionIndex + 1, 1);
                    
                    this.updateUIAfterChange('ØªÙ… Ø¯Ù…Ø¬ Ø§Ù„Ø³Ø¤Ø§Ù„ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­');
                }
            }

            openCustomizeModal() {
                document.getElementById('customizeModal').style.display = 'flex';
                document.getElementById('categorySelect').value = this.customization.category;
                document.getElementById('countrySelect').value = this.customization.country;
                document.getElementById('dialectSelect').value = this.customization.dialect;
            }
            closeCustomizeModal() {
                document.getElementById('customizeModal').style.display = 'none';
            }
            saveCustomization() {
                this.handleCustomizationChange();
                this.closeCustomizeModal();
                this.showMessage('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }

            handleCustomizationChange() {
                this.customization.category = document.getElementById('categorySelect').value;
                this.customization.country = document.getElementById('countrySelect').value;
                this.customization.dialect = document.getElementById('dialectSelect').value;
                this.saveSettings();
                const jsonOutput = document.getElementById('jsonOutput');
                if (jsonOutput && jsonOutput.style.display === 'block') {
                    this.convertToJSON();
                }
            }

            // ===== Core Processing Logic =====
            
            processText(text) {
                try {
                    const questionBlocks = this.intelligentQuestionSplitting(text);
                    if (questionBlocks.length === 0) {
                        this.showMessage('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ­Ù„ÙŠÙ„.', 'warning');
                        return;
                    }
                    this.questions = questionBlocks.map((block, index) => this.analyzeQuestion(block, index + 1));
                    this.updateUIAfterChange('ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ Ø¨Ù†Ø¬Ø§Ø­.');
                } catch (error) {
                    this.showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„: ' + error.message, 'error');
                }
            }
            
            intelligentQuestionSplitting(text) {
                return text.split(/(?=\n*\s*\d+\s*[.-])|(?=\n\n)/)
                           .filter(block => block.trim().length > 5)
                           .map(b => b.trim());
            }

            analyzeQuestion(block, id) {
                const type = this.detectQuestionType(block);
                let structure = { question: block, answer: null };
                let confidence = 0.5;

                try {
                    switch (type) {
                        case 'multiple_choice': structure = this.analyzeMultipleChoice(block); confidence = 0.9; break;
                        case 'true_false': structure = this.analyzeTrueFalse(block); confidence = 0.95; break;
                        default: structure = { question: block.replace(/^\d+\s*[.-]\s*/, '').trim(), choices: [], answer: null }; confidence = 0.6;
                    }
                } catch {
                    structure = { question: block, choices: [], answer: null };
                    confidence = 0.3;
                }
                
                return { id, originalText: block, type, confidence: Math.min(confidence, 1.0), ...structure };
            }

            detectQuestionType(text) {
                const langPatterns = this.language === 'ar' ? this.patterns : {
                    trueFalse: this.patterns.en_trueFalse,
                    multipleChoice: this.patterns.en_multipleChoice,
                    essay: this.patterns.en_essay
                };

                if (langPatterns.trueFalse.test(text)) return 'true_false';
                
                const lines = text.split('\n');
                const choiceMarker = this.language === 'ar' ? /^[Ø£-ÙŠ]\s*[.)-]/ : /^[A-Da-d]\s*[.)-]/;
                if (lines.some(line => choiceMarker.test(line.trim()))) return 'multiple_choice';

                if (langPatterns.essay.test(text)) return 'essay';
                return 'unknown';
            }

            analyzeMultipleChoice(text) {
                const lines = text.split('\n').filter(line => line.trim() !== '');
                let question = lines[0].replace(/^\d+\s*[.-]\s*/, '').trim();
                const choices = [];
                let correctAnswerIndex = null;
                
                const choiceMarker = this.language === 'ar' ? /^[Ø£-ÙŠ]\s*[.)-]\s*/ : /^[A-Da-d]\s*[.)-]\s*/;

                for (let i = 1; i < lines.length; i++) {
                    let choiceText = lines[i].trim();
                    if (!choiceMarker.test(choiceText)) {
                        question += ' ' + choiceText;
                        continue;
                    }

                    choiceText = choiceText.replace(choiceMarker, '').trim();
                    if (choiceText.includes('*')) {
                        correctAnswerIndex = choices.length;
                        choiceText = choiceText.replace(/\*/g, '').trim();
                    }
                    choices.push(choiceText);
                }
                return { question, choices, answer: correctAnswerIndex };
            }

            analyzeTrueFalse(text) {
                let question, answer = null;
                const patterns = this.language === 'ar' 
                    ? { regex: /(ØµØ­\s*(Ø£Ù…|Ø£Ùˆ|\/)\s*Ø®Ø·Ø£)/i, choices: ['ØµØ­', 'Ø®Ø·Ø£'], trueStr: 'ØµØ­', falseStr: 'Ø®Ø·Ø£' }
                    : { regex: /(true\s*(or|\/)\s*false)/i, choices: ['True', 'False'], trueStr: 'true', falseStr: 'false' };
                
                question = text.replace(patterns.regex, '').trim();
                const match = text.match(/\((.*?)\)/);
                if (match) {
                    const answerText = match[1].trim().toLowerCase();
                    if (answerText === patterns.trueStr.toLowerCase()) answer = 0;
                    if (answerText === patterns.falseStr.toLowerCase()) answer = 1;
                    question = question.replace(/\(.*?\)/, '').trim();
                }
                return { question, choices: patterns.choices, answer };
            }

            // ===== UI Update & Utility Functions =====

            updateUIAfterChange(message) {
                this.questions.forEach((q, index) => { q.id = index + 1; });
                this.updateStatistics();
                this.displayResults();
                const jsonOutput = document.getElementById('jsonOutput');
                if (jsonOutput.style.display === 'block') { this.convertToJSON(); }
                document.getElementById('downloadZipBtn').disabled = this.questions.length === 0;
                if (message) { this.showMessage(message, 'success'); }
            }

            showLoading(isLoading, text = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...') {
                const loadingDiv = document.getElementById('loading');
                loadingDiv.querySelector('p').textContent = text;
                loadingDiv.style.display = isLoading ? 'block' : 'none';
            }

            toggleAIButtonLoading(isLoading) {
                const btn = document.getElementById('aiEnhanceBtn');
                if (isLoading) {
                    btn.disabled = true;
                    btn.innerHTML = '<div class="spinner"></div> <span>Ø¬Ø§Ø±ÙŠ...</span>';
                } else {
                    btn.disabled = false;
                    btn.innerHTML = this.language === 'ar' ? 'ğŸ’ ØªØ­Ø³ÙŠÙ† Ø¨Ø§Ù„Ù€ AI' : 'ğŸ’ Enhance with AI';
                }
            }

            showMessage(text, type = 'success') {
                const container = document.getElementById('messageContainer');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.textContent = text;
                container.appendChild(messageDiv);
                setTimeout(() => { messageDiv.remove(); }, 4000);
            }
            
            updateStatistics() {
                const counts = { multiple_choice: 0, true_false: 0, essay: 0, unknown: 0 };
                let totalConfidence = 0;
                this.questions.forEach(q => {
                    counts[q.type] = (counts[q.type] || 0) + 1;
                    totalConfidence += (q.confidence || 0.5);
                });
                
                const total = this.questions.length;
                document.getElementById('totalQuestions').textContent = total;
                document.getElementById('multipleChoice').textContent = counts.multiple_choice;
                document.getElementById('trueFalse').textContent = counts.true_false;
                document.getElementById('essay').textContent = counts.essay;
                document.getElementById('unknown').textContent = counts.unknown;

                const avgConfidence = total > 0 ? (totalConfidence / total) : 0;
                const confidencePercent = Math.round(avgConfidence * 100);
                document.getElementById('confidenceScore').textContent = `${confidencePercent}%`;
                document.getElementById('detectionQuality').style.width = `${confidencePercent}%`;
                document.getElementById('classificationAccuracy').style.width = `${Math.round(avgConfidence * 95)}%`;
                document.getElementById('dataCompleteness').style.width = `${Math.round(avgConfidence * 90)}%`;
            }

            displayResults() {
                const previewContainer = document.getElementById('questionsPreview');
                previewContainer.innerHTML = '';
                if (this.questions.length === 0) {
                    previewContainer.innerHTML = `<div style="text-align: center; color: #6b7280; padding: 40px; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“‹</div>
                        <p>${this.language === 'ar' ? 'Ø³ØªØ¸Ù‡Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„' : 'Questions preview will appear here'}</p>
                    </div>`;
                    return;
                }
                this.questions.forEach((q, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question-preview';
                    const typeTranslations = { multiple_choice: 'Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯', true_false: 'ØµØ­ / Ø®Ø·Ø£', fill_blank: 'Ù…Ù„Ø¡ Ø§Ù„ÙØ±Ø§Øº', essay: 'Ù…Ù‚Ø§Ù„ÙŠ', matching: 'Ù…Ø·Ø§Ø¨Ù‚Ø©', short_answer: 'Ø¥Ø¬Ø§Ø¨Ø© Ù‚ØµÙŠØ±Ø©', unknown: 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' };
                    const enTypeTranslations = { multiple_choice: 'Multiple Choice', true_false: 'True/False', fill_blank: 'Fill in the Blank', essay: 'Essay', matching: 'Matching', short_answer: 'Short Answer', unknown: 'Unknown' };
                    const translations = this.language === 'ar' ? typeTranslations : enTypeTranslations;
                    
                    const questionIdFromCsv = (this.csvData && this.csvData[index] && this.csvData[index]['Question Id']);
                    const displayId = questionIdFromCsv || `(ÙØ§Ø±Øº)`;

                    let content = `
                        <div class="question-actions">
                            <button class="action-btn" onclick="app.mergeQuestions(${q.id})" title="Ø¯Ù…Ø¬ Ù…Ø¹ Ø§Ù„ØªØ§Ù„ÙŠ" ${index === this.questions.length - 1 ? 'disabled' : ''}>ğŸ”—</button>
                            <button class="action-btn" onclick="app.deleteQuestion(${q.id})" title="Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„">ğŸ—‘ï¸</button>
                        </div>
                        <div class="question-type-badge type-${q.type || 'unknown'}">
                            ${translations[q.type] || 'Unknown'} | ID: ${displayId}
                        </div>
                        <h4>${q.id}. <span class="question-stem" style="display:inline;">${this.escapeHtml(q.question)}</span></h4>`;
                    
                    if (q.choices && q.choices.length > 0) {
                        content += q.choices.map((choice, i) => `
                            <div class="choice-item ${i === q.answer ? 'correct' : ''}"
                                 style="cursor:pointer;"
                                 onclick="app.setCorrectAnswer(${q.id}, ${i})"
                                 title="Ø§Ø¶ØºØ· Ù„Ø¬Ø¹Ù„ Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø¬ÙˆØ§Ø¨ Ø§Ù„ØµØ­ÙŠØ­">
                                 ${this.escapeHtml(choice)}
                            </div>`).join('');
                    } else if (q.answer !== null && q.answer !== undefined && q.answer !== '') {
                         content += `<div class="choice-item correct">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: ${this.escapeHtml(q.answer)}</div>`;
                    }
                    questionDiv.innerHTML = content;
                    previewContainer.appendChild(questionDiv);
                });
            }
            
            escapeHtml(text) {
                if (typeof text !== 'string') return text;
                const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                return text.replace(/[&<>"']/g, m => map[m]);
            }

            syntaxHighlight(json) {
                json = this.escapeHtml(json);
                return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, (match) => {
                    let cls = 'number';
                    if (/^"/.test(match)) { cls = /:$/.test(match) ? 'key' : 'string'; } 
                    else if (/true|false/.test(match)) { cls = 'boolean'; } 
                    else if (/null/.test(match)) { cls = 'null'; }
                    return '<span class="' + cls + '">' + match + '</span>';
                });
            }
            
            async callGeminiAPI(prompt, apiKey) {
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        response_mime_type: "application/json",
                        temperature: 0.2,
                        maxOutputTokens: 8192,
                    }
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error('API Error Response:', errorBody);
                    throw new Error(errorBody.error?.message || `ÙØ´Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ù„Ø­Ø§Ù„Ø© ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0].content || !data.candidates[0].content.parts) {
                    console.error('Invalid API Response Structure:', data);
                    throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© Ù…Ù† API.');
                }
                
                const jsonText = data.candidates[0].content.parts[0].text;
                try {
                    return JSON.parse(jsonText);
                } catch (e) {
                    console.error("Failed to parse AI response as JSON:", jsonText);
                    throw new Error("ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠØŒ Ù‚Ø¯ Ù„Ø§ ØªÙƒÙˆÙ† Ø¨ØµÙŠØºØ© JSON ØµØ­ÙŠØ­Ø©.");
                }
            }

            toggleLanguage() {
                this.language = this.language === 'ar' ? 'en' : 'ar';
                this.updateInterfaceLanguage();
                this.saveSettings();
                const jsonOutput = document.getElementById('jsonOutput');
                if (jsonOutput && jsonOutput.style.display === 'block') {
                    this.convertToJSON();
                }
            }

            updateInterfaceLanguage() {
                const isAr = this.language === 'ar';
                document.documentElement.lang = isAr ? 'ar' : 'en';
                document.documentElement.dir = isAr ? 'rtl' : 'ltr';
                document.getElementById('langSwitchBtn').innerHTML = isAr ? 'ğŸŒ English' : 'ğŸŒ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
                document.querySelector('.header h1').textContent = isAr ? 'ğŸš€ Ù…Ø­ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø°ÙƒÙŠ' : 'ğŸš€ Smart Question Converter';
                document.querySelector('.header p').textContent = isAr ? 'Ø­ÙˆÙ‘Ù„ Ù†ØµÙˆØµ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¥Ù„Ù‰ ØµÙŠØºØ© JSON Ù…ØªÙ‚Ø¯Ù…Ø© Ø¨Ø¶ØºØ·Ø© Ø²Ø±' : 'Convert question texts to advanced JSON format with one click';
                document.querySelector('.ai-badge').textContent = isAr ? 'ğŸ¤– AI Powered' : 'ğŸ¤– AI Powered';
                document.querySelectorAll('.panel h3')[0].innerHTML = isAr ? 'ğŸ“ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©' : 'ğŸ“ Input Questions';
                document.querySelectorAll('.panel h3')[1].innerHTML = isAr ? 'ğŸ” ØªØ­Ù„ÙŠÙ„ ÙˆÙ…Ø®Ø±Ø¬Ø§Øª' : 'ğŸ” Analysis & Output';
                document.querySelectorAll('.panel h3')[2].innerHTML = isAr ? 'ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©' : 'ğŸ‘ï¸ Questions Preview';
                document.getElementById('questionInput').placeholder = isAr ?
                    'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‡Ù†Ø§... Ù…Ø«Ø§Ù„:\n1. Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ù…ØµØ±ØŸ\nØ£) Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©*\nØ¨) Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©\n\n2. Ø§Ù„Ø´Ù…Ø³ ØªØ´Ø±Ù‚ Ù…Ù† Ø§Ù„ØºØ±Ø¨. (Ø®Ø·Ø£)'
                    :
                    'Enter questions here... Example:\n1. What is the capital of Egypt?\nA) Cairo*\nB) Alexandria\n\n2. The sun rises from the west. (False)';
                document.querySelector('.btn-primary[onclick*="smartAnalyze"]').textContent = isAr ? 'ğŸ¤– ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ' : 'ğŸ¤– Smart Analyze';
                this.toggleAIButtonLoading(this.isAIProcessing); 
                document.getElementById('customizeBtn').innerHTML = isAr ? 'âš™ï¸ ØªØ®ØµÙŠØµ' : 'âš™ï¸ Customize';
                document.querySelector('.btn-success[onclick*="convertToJSON"]').textContent = isAr ? 'ğŸ”„ ØªØ­ÙˆÙŠÙ„ Ù„Ù€ JSON Ù…ØªÙ‚Ø¯Ù…' : 'ğŸ”„ Convert to Advanced JSON';
                document.querySelector('.btn-secondary[onclick*="clearAll"]').textContent = isAr ? 'ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„' : 'ğŸ—‘ï¸ Clear All';
                const analysisLabels = isAr ? ['Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒØ´Ù:', 'Ø¯Ù‚Ø© Ø§Ù„ØªØµÙ†ÙŠÙ:', 'Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:'] : ['Detection Quality:', 'Classification Accuracy:', 'Data Completeness:'];
                document.querySelectorAll('.analysis-item span')[0].textContent = analysisLabels[0];
                document.querySelectorAll('.analysis-item span')[1].textContent = analysisLabels[1];
                document.querySelectorAll('.analysis-item span')[2].textContent = analysisLabels[2];
                const statLabels = isAr ? ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©', 'Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯', 'ØµØ­/Ø®Ø·Ø£', 'Ù…Ù‚Ø§Ù„ÙŠØ©', 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ', 'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø«Ù‚Ø©'] : ['Total Questions', 'Multiple Choice', 'True/False', 'Essay', 'Unknown', 'Confidence'];
                document.querySelectorAll('.stat-card h4').forEach((el, i) => el.textContent = statLabels[i]);
                document.getElementById('copyBtn').textContent = isAr ? 'ğŸ“‹ Ù†Ø³Ø® JSON' : 'ğŸ“‹ Copy JSON';
                document.getElementById('downloadBtn').textContent = isAr ? 'ğŸ’¾ ØªØ­Ù…ÙŠÙ„' : 'ğŸ’¾ Download';
                document.getElementById('downloadZipBtn').textContent = isAr ? 'ğŸ—œï¸ ØªØ­Ù…ÙŠÙ„ ÙƒÙ€ ZIP' : 'ğŸ—œï¸ Download as ZIP';
                document.querySelector('#customizeModal h2').textContent = isAr ? 'ØªØ®ØµÙŠØµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª' : 'Customize Settings';
                document.querySelector('label[for="categorySelect"]').textContent = isAr ? 'Ø§Ù„ÙØ¦Ø©' : 'Category';
                document.querySelector('label[for="countrySelect"]').textContent = isAr ? 'Ø§Ù„Ø¯ÙˆÙ„Ø©' : 'Country';
                document.querySelector('label[for="dialectSelect"]').textContent = isAr ? 'Ø§Ù„Ù„Ù‡Ø¬Ø©' : 'Dialect';
                document.querySelector('#customizeModal .btn-primary').textContent = isAr ? 'Ø­ÙØ¸' : 'Save';
                this.displayResults();
            }

            setCorrectAnswer(questionId, choiceIndex) {
                const q = this.questions.find(q => q.id === questionId);
                if (!q || !Array.isArray(q.choices)) return;
                q.answer = choiceIndex;
                this.updateUIAfterChange('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©');
            }

            saveSettings() {
                const settings = {
                    customization: this.customization,
                    language: this.language
                };
                localStorage.setItem('aiq_settings', JSON.stringify(settings));
            }

            loadSettings() {
                try {
                    const settings = JSON.parse(localStorage.getItem('aiq_settings'));
                    if (settings) {
                        if (settings.customization) this.customization = settings.customization;
                        if (settings.language) this.language = settings.language;
                    }
                } catch {}
            }

            saveApiKey() {
                const apiKey = document.getElementById('apiKey').value.trim();
                this.apiKey = apiKey;
                localStorage.setItem('aiq_api_key', apiKey);
            }

            loadApiKey() {
                const apiKey = localStorage.getItem('aiq_api_key');
                if (apiKey) {
                    this.apiKey = apiKey;
                }
            }
            
            // ===== CSV Logic =====
            openCSVModal() {
                if (this.questions.length === 0) {
                    this.showMessage('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ ÙØªØ­ Ø¬Ø¯ÙˆÙ„ CSV', 'warning');
                    return;
                }
                const columns = [
                    {data: 'Question Id', type: 'text'},
                    {data: 'Lang', type: 'text', readOnly: true},
                    {data: 'Lesson Id', type: 'text'},
                    {data: 'Attributes', type: 'text', readOnly: true},
                    {data: 'Category', type: 'text', readOnly: true},
                    {data: 'Dialect', type: 'text', readOnly: true}
                ];
                const saved = localStorage.getItem('aiq_csv_data');
                if (saved) {
                    this.csvData = JSON.parse(saved);
                } else {
                    const defaultLang = this.customization.country || 'eg';
                    const defaultCategory = this.customization.category || 'lesson';
                    const defaultDialect = this.customization.dialect || 'Modern_standard';
                    this.csvData = this.questions.map((q, idx) => ({
                        'Question Id': '', // Start with empty ID
                        'Lang': defaultLang,
                        'Lesson Id': '',
                        'Attributes': q.type === 'multiple_choice' ? 'mcq' : (q.type || ''),
                        'Category': defaultCategory,
                        'Dialect': defaultDialect
                    }));
                }
                document.getElementById('csvModalBg').style.display = 'flex';
                if (this.hotInstance) this.hotInstance.destroy();
                this.hotInstance = new Handsontable(document.getElementById('hotTable'), {
                    data: this.csvData,
                    colHeaders: ['Question Id', 'Lang', 'Lesson Id', 'Attributes', 'Category', 'Dialect'],
                    columns: columns,
                    rowHeaders: true,
                    width: '100%',
                    height: 500,
                    licenseKey: 'non-commercial-and-evaluation',
                    manualColumnResize: true,
                    manualRowResize: true,
                    stretchH: 'all',
                    allowInsertRow: true,
                    allowRemoveRow: true,
                    contextMenu: true,
                });
            }

            closeCSVModal() {
                document.getElementById('csvModalBg').style.display = 'none';
                if (this.hotInstance) this.hotInstance.destroy();
                this.hotInstance = null;
            }

            saveCSVData() { 
                if (this.hotInstance) {
                    this.csvData = this.hotInstance.getData().map(row => {
                        return {
                            'Question Id': row[0], 'Lang': row[1], 'Lesson Id': row[2],
                            'Attributes': row[3], 'Category': row[4], 'Dialect': row[5]
                        };
                    });
                    localStorage.setItem('aiq_csv_data', JSON.stringify(this.csvData));
                    this.showMessage('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª CSV Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    this.closeCSVModal();
                    this.displayResults();
                }
            }

            getCSVString() {
                const header = ['Question Id', 'Lang', 'Lesson Id', 'Attributes', 'Category', 'Dialect'];
                const rows = this.csvData.map(row => header.map(h => `"${(row[h] || '').toString().replace(/"/g, '""')}"`));
                return [header.join(',')].concat(rows.map(r => r.join(','))).join('\n');
            }
        }

        const app = new AIQuestionConverter();
        window.addEventListener('DOMContentLoaded', () => {
            app.updateInterfaceLanguage();
            document.getElementById('categorySelect').value = app.customization.category;
            document.getElementById('countrySelect').value = app.customization.country;
            document.getElementById('dialectSelect').value = app.customization.dialect;
            if (app.apiKey) {
                document.getElementById('apiKey').value = app.apiKey;
            }
            document.getElementById('apiKey').addEventListener('input', () => app.saveApiKey());
        });
    </script>
</body>
</html>
